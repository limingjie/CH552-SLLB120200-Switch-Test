//
// SSD1306 128x64 OLED library
//
// Required Libraries
// - I2C library from https://github.com/wagiminator/CH552-USB-OLED
//
// References
// - https://github.com/wagiminator/CH552-USB-OLED
//
// Apr 2023 by Li Mingjie
// - Email:  limingjie@outlook.com
// - GitHub: https://github.com/limingjie/
//

#include "oled.h"

#include "i2c.h"

// OLED definitions
#define OLED_ADDR      0x78  // OLED write address (0x3C << 1)
#define OLED_CMD_MODE  0x00  // set command mode
#define OLED_DATA_MODE 0x40  // set data mode

// OLED commands
#define OLED_COLUMN_LOW        0x00  // set lower 4 bits of start column (0x00 - 0x0F)
#define OLED_COLUMN_HIGH       0x10  // set higher 4 bits of start column (0x10 - 0x1F)
#define OLED_MEMORY_MODE       0x20  // Set memory addressing mode (following byte)
#define OLED_COLUMNS           0x21  // set start and end column (following 2 bytes)
#define OLED_PAGES             0x22  // set start and end page (following 2 bytes)
#define OLED_STARTLINE         0x40  // set display start line (0x40-0x7F = 0-63)
#define OLED_CONTRAST          0x81  // Set display contrast (following a byte, 0-255) - (Reset 0x7F)
#define OLED_CHARGE_PUMP       0x8D  // (following byte - 0x14:enable, 0x10: disable)
#define OLED_XFLIP_OFF         0xA0  // don't flip display horizontally
#define OLED_XFLIP_ON          0xA1  // flip display horizontally
#define OLEF_RESUME_DISPLAY    0xA4  // Resume to RAM content display
#define OLEF_ENTIRE_DISPLAY_ON 0xA5  // Entire display ON
#define OLEF_NORMAL_DISPLAY    0xA6  // Normal display - (Reset)
#define OLED_INVERT_DISPLAY    0xA7  // Inverse display
#define OLED_MULTIPLEX         0xA8  // set multiplex ratio (following byte)
#define OLED_DISPLAY_OFF       0xAE  // Display OFF (sleep mode) - (Reset)
#define OLED_DISPLAY_ON        0xAF  // Display ON in normal mode
#define OLED_PAGE              0xB0  // set start page (following byte)
#define OLED_YFLIP_OFF         0xC0  // don't flip display vertically
#define OLED_YFLIP_ON          0xC8  // flip display vertically
#define OLED_OFFSET            0xD3  // set display offset (y-scroll: following byte)
#define OLED_COM_PINS          0xDA  // set COM pin config (following byte)

// Standard ASCII 5x8 font (adapted from Neven Boyanov and Stephen Denne)
__code uint8_t OLED_FONT_5x8[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2F, 0x00, 0x00, 0x00, 0x07, 0x00, 0x07, 0x00, 0x14, 0x7F, 0x14, 0x7F,
    0x14, 0x24, 0x2A, 0x7F, 0x2A, 0x12, 0x23, 0x13, 0x08, 0x64, 0x62, 0x36, 0x49, 0x55, 0x22, 0x50, 0x00, 0x05, 0x03,
    0x00, 0x00, 0x00, 0x1C, 0x22, 0x41, 0x00, 0x00, 0x41, 0x22, 0x1C, 0x00, 0x14, 0x08, 0x3E, 0x08, 0x14, 0x08, 0x08,
    0x3E, 0x08, 0x08, 0x00, 0x00, 0xA0, 0x60, 0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x60, 0x60, 0x00, 0x00, 0x20,
    0x10, 0x08, 0x04, 0x02, 0x3E, 0x51, 0x49, 0x45, 0x3E, 0x00, 0x42, 0x7F, 0x40, 0x00, 0x42, 0x61, 0x51, 0x49, 0x46,
    0x21, 0x41, 0x45, 0x4B, 0x31, 0x18, 0x14, 0x12, 0x7F, 0x10, 0x27, 0x45, 0x45, 0x45, 0x39, 0x3C, 0x4A, 0x49, 0x49,
    0x30, 0x01, 0x71, 0x09, 0x05, 0x03, 0x36, 0x49, 0x49, 0x49, 0x36, 0x06, 0x49, 0x49, 0x29, 0x1E, 0x00, 0x36, 0x36,
    0x00, 0x00, 0x00, 0x56, 0x36, 0x00, 0x00, 0x08, 0x14, 0x22, 0x41, 0x00, 0x14, 0x14, 0x14, 0x14, 0x14, 0x00, 0x41,
    0x22, 0x14, 0x08, 0x02, 0x01, 0x51, 0x09, 0x06, 0x32, 0x49, 0x59, 0x51, 0x3E, 0x7C, 0x12, 0x11, 0x12, 0x7C, 0x7F,
    0x49, 0x49, 0x49, 0x36, 0x3E, 0x41, 0x41, 0x41, 0x22, 0x7F, 0x41, 0x41, 0x22, 0x1C, 0x7F, 0x49, 0x49, 0x49, 0x41,
    0x7F, 0x09, 0x09, 0x09, 0x01, 0x3E, 0x41, 0x49, 0x49, 0x7A, 0x7F, 0x08, 0x08, 0x08, 0x7F, 0x00, 0x41, 0x7F, 0x41,
    0x00, 0x20, 0x40, 0x41, 0x3F, 0x01, 0x7F, 0x08, 0x14, 0x22, 0x41, 0x7F, 0x40, 0x40, 0x40, 0x40, 0x7F, 0x02, 0x0C,
    0x02, 0x7F, 0x7F, 0x04, 0x08, 0x10, 0x7F, 0x3E, 0x41, 0x41, 0x41, 0x3E, 0x7F, 0x09, 0x09, 0x09, 0x06, 0x3E, 0x41,
    0x51, 0x21, 0x5E, 0x7F, 0x09, 0x19, 0x29, 0x46, 0x46, 0x49, 0x49, 0x49, 0x31, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x3F,
    0x40, 0x40, 0x40, 0x3F, 0x1F, 0x20, 0x40, 0x20, 0x1F, 0x3F, 0x40, 0x38, 0x40, 0x3F, 0x63, 0x14, 0x08, 0x14, 0x63,
    0x07, 0x08, 0x70, 0x08, 0x07, 0x61, 0x51, 0x49, 0x45, 0x43, 0x00, 0x7F, 0x41, 0x41, 0x00, 0x02, 0x04, 0x08, 0x10,
    0x20, 0x00, 0x41, 0x41, 0x7F, 0x00, 0x04, 0x02, 0x01, 0x02, 0x04, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00, 0x01, 0x02,
    0x04, 0x00, 0x20, 0x54, 0x54, 0x54, 0x78, 0x7F, 0x48, 0x44, 0x44, 0x38, 0x38, 0x44, 0x44, 0x44, 0x20, 0x38, 0x44,
    0x44, 0x48, 0x7F, 0x38, 0x54, 0x54, 0x54, 0x18, 0x08, 0x7E, 0x09, 0x01, 0x02, 0x18, 0xA4, 0xA4, 0xA4, 0x7C, 0x7F,
    0x08, 0x04, 0x04, 0x78, 0x00, 0x44, 0x7D, 0x40, 0x00, 0x40, 0x80, 0x84, 0x7D, 0x00, 0x7F, 0x10, 0x28, 0x44, 0x00,
    0x00, 0x41, 0x7F, 0x40, 0x00, 0x7C, 0x04, 0x18, 0x04, 0x78, 0x7C, 0x08, 0x04, 0x04, 0x78, 0x38, 0x44, 0x44, 0x44,
    0x38, 0xFC, 0x24, 0x24, 0x24, 0x18, 0x18, 0x24, 0x24, 0x18, 0xFC, 0x7C, 0x08, 0x04, 0x04, 0x08, 0x48, 0x54, 0x54,
    0x54, 0x20, 0x04, 0x3F, 0x44, 0x40, 0x20, 0x3C, 0x40, 0x40, 0x20, 0x7C, 0x1C, 0x20, 0x40, 0x20, 0x1C, 0x3C, 0x40,
    0x30, 0x40, 0x3C, 0x44, 0x28, 0x10, 0x28, 0x44, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C, 0x44, 0x64, 0x54, 0x4C, 0x44, 0x08,
    0x36, 0x41, 0x41, 0x00, 0x00, 0x00, 0x7F, 0x00, 0x00, 0x00, 0x41, 0x41, 0x36, 0x08, 0x08, 0x04, 0x08, 0x10, 0x08,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF};

// https://github.com/datacute/TinyOLED-Fonts/blob/master/src/ModernDos.h
__code uint8_t OLED_FONT_DOS_8x16[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38,
    0xfc, 0xfc, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0d, 0x0d, 0x00, 0x00, 0x00, 0x00, 0x06, 0x1e, 0x00, 0x00, 0x06,
    0x1e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0xf0, 0xf0, 0x40, 0xf0, 0xf0, 0x40, 0x00, 0x02,
    0x0f, 0x0f, 0x02, 0x0f, 0x0f, 0x02, 0x00, 0x30, 0x78, 0xc8, 0xfe, 0x88, 0x38, 0x30, 0x00, 0x06, 0x0e, 0x08, 0x3f,
    0x09, 0x0f, 0x06, 0x00, 0x18, 0x24, 0xa4, 0xd8, 0x60, 0x30, 0x18, 0x00, 0x06, 0x03, 0x01, 0x06, 0x09, 0x09, 0x06,
    0x00, 0x00, 0x98, 0xfc, 0xe4, 0x3c, 0x98, 0x80, 0x00, 0x07, 0x0f, 0x08, 0x09, 0x07, 0x0f, 0x08, 0x00, 0x00, 0x00,
    0x00, 0x16, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xf8, 0x0c,
    0x04, 0x00, 0x00, 0x00, 0x00, 0x03, 0x07, 0x0c, 0x08, 0x00, 0x00, 0x00, 0x00, 0x04, 0x0c, 0xf8, 0xf0, 0x00, 0x00,
    0x00, 0x00, 0x08, 0x0c, 0x07, 0x03, 0x00, 0x00, 0x80, 0xa0, 0xe0, 0xc0, 0xc0, 0xe0, 0xa0, 0x80, 0x00, 0x02, 0x03,
    0x01, 0x01, 0x03, 0x02, 0x00, 0x00, 0x80, 0x80, 0xe0, 0xe0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2c, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0x60, 0x30, 0x18,
    0x00, 0x06, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0x84, 0xc4, 0x64, 0xfc, 0xf8, 0x00, 0x07, 0x0f,
    0x09, 0x08, 0x08, 0x0f, 0x07, 0x00, 0x00, 0x10, 0x18, 0xfc, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x0f, 0x0f,
    0x08, 0x08, 0x00, 0x08, 0x0c, 0x84, 0xc4, 0x64, 0x3c, 0x18, 0x00, 0x0e, 0x0f, 0x09, 0x08, 0x08, 0x0c, 0x0c, 0x00,
    0x08, 0x0c, 0x44, 0x44, 0x44, 0xfc, 0xb8, 0x00, 0x04, 0x0c, 0x08, 0x08, 0x08, 0x0f, 0x07, 0x00, 0xc0, 0xe0, 0x30,
    0x18, 0xfc, 0xfc, 0x00, 0x00, 0x01, 0x01, 0x01, 0x09, 0x0f, 0x0f, 0x09, 0x00, 0x7c, 0x7c, 0x44, 0x44, 0x44, 0xc4,
    0x84, 0x00, 0x04, 0x0c, 0x08, 0x08, 0x08, 0x0f, 0x07, 0x00, 0xf8, 0xfc, 0x44, 0x44, 0x44, 0xcc, 0x88, 0x00, 0x07,
    0x0f, 0x08, 0x08, 0x08, 0x0f, 0x07, 0x00, 0x0c, 0x0c, 0x04, 0x84, 0xc4, 0x7c, 0x3c, 0x00, 0x00, 0x00, 0x0f, 0x0f,
    0x00, 0x00, 0x00, 0x00, 0xb8, 0xfc, 0x44, 0x44, 0x44, 0xfc, 0xb8, 0x00, 0x07, 0x0f, 0x08, 0x08, 0x08, 0x0f, 0x07,
    0x00, 0x78, 0xfc, 0x84, 0x84, 0x84, 0xfc, 0xf8, 0x00, 0x04, 0x0c, 0x08, 0x08, 0x08, 0x0f, 0x07, 0x00, 0x00, 0x00,
    0x00, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x16, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0x60, 0x30, 0x18, 0x08, 0x00,
    0x00, 0x00, 0x01, 0x03, 0x06, 0x0c, 0x08, 0x00, 0x00, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x00, 0x00, 0x01, 0x01,
    0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x08, 0x18, 0x30, 0x60, 0xc0, 0x80, 0x00, 0x00, 0x08, 0x0c, 0x06, 0x03, 0x01,
    0x00, 0x00, 0x18, 0x1c, 0x04, 0x84, 0xc4, 0x7c, 0x38, 0x00, 0x00, 0x00, 0x00, 0x0d, 0x0d, 0x00, 0x00, 0x00, 0xe0,
    0x10, 0xc8, 0x28, 0x28, 0xe8, 0x10, 0xe0, 0x03, 0x04, 0x0b, 0x0a, 0x09, 0x0b, 0x02, 0x01, 0xf0, 0xf8, 0x8c, 0x84,
    0x8c, 0xf8, 0xf0, 0x00, 0x0f, 0x0f, 0x00, 0x00, 0x00, 0x0f, 0x0f, 0x00, 0x04, 0xfc, 0xfc, 0x44, 0x44, 0xfc, 0xb8,
    0x00, 0x08, 0x0f, 0x0f, 0x08, 0x08, 0x0f, 0x07, 0x00, 0xf8, 0xfc, 0x04, 0x04, 0x04, 0x1c, 0x18, 0x00, 0x07, 0x0f,
    0x08, 0x08, 0x08, 0x0e, 0x06, 0x00, 0x04, 0xfc, 0xfc, 0x04, 0x04, 0xfc, 0xf8, 0x00, 0x08, 0x0f, 0x0f, 0x08, 0x08,
    0x0f, 0x07, 0x00, 0x04, 0xfc, 0xfc, 0xc4, 0xe4, 0x0c, 0x1c, 0x00, 0x08, 0x0f, 0x0f, 0x08, 0x09, 0x0c, 0x0e, 0x00,
    0x04, 0xfc, 0xfc, 0xc4, 0xe4, 0x0c, 0x1c, 0x00, 0x08, 0x0f, 0x0f, 0x08, 0x01, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0x04,
    0x04, 0x84, 0x9c, 0x98, 0x00, 0x07, 0x0f, 0x08, 0x08, 0x08, 0x0f, 0x0f, 0x00, 0xfc, 0xfc, 0x40, 0x40, 0x40, 0xfc,
    0xfc, 0x00, 0x0f, 0x0f, 0x00, 0x00, 0x00, 0x0f, 0x0f, 0x00, 0x00, 0x00, 0x04, 0xfc, 0xfc, 0x04, 0x00, 0x00, 0x00,
    0x00, 0x08, 0x0f, 0x0f, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0xfc, 0xfc, 0x04, 0x00, 0x06, 0x0e, 0x08, 0x08,
    0x0f, 0x07, 0x00, 0x00, 0x04, 0xfc, 0xfc, 0xc0, 0xe0, 0x3c, 0x1c, 0x00, 0x08, 0x0f, 0x0f, 0x00, 0x01, 0x0f, 0x0e,
    0x00, 0x04, 0xfc, 0xfc, 0x04, 0x00, 0x00, 0x00, 0x00, 0x08, 0x0f, 0x0f, 0x08, 0x08, 0x0c, 0x0e, 0x00, 0xfc, 0xf8,
    0x70, 0xe0, 0x70, 0xf8, 0xfc, 0x00, 0x0f, 0x0f, 0x00, 0x00, 0x00, 0x0f, 0x0f, 0x00, 0xfc, 0xf8, 0x70, 0xe0, 0xc0,
    0xfc, 0xfc, 0x00, 0x0f, 0x0f, 0x00, 0x00, 0x01, 0x0f, 0x0f, 0x00, 0xf8, 0xfc, 0x04, 0x04, 0x04, 0xfc, 0xf8, 0x00,
    0x07, 0x0f, 0x08, 0x08, 0x08, 0x0f, 0x07, 0x00, 0x04, 0xfc, 0xfc, 0x84, 0x84, 0xfc, 0x78, 0x00, 0x08, 0x0f, 0x0f,
    0x08, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0x04, 0x04, 0x04, 0xfc, 0xf8, 0x00, 0x07, 0x0f, 0x08, 0x0e, 0x0c, 0x1f,
    0x17, 0x00, 0x04, 0xfc, 0xfc, 0x84, 0x84, 0xfc, 0x78, 0x00, 0x08, 0x0f, 0x0f, 0x00, 0x01, 0x0f, 0x0e, 0x00, 0x18,
    0x3c, 0x64, 0x44, 0xc4, 0x9c, 0x18, 0x00, 0x06, 0x0e, 0x08, 0x08, 0x08, 0x0f, 0x07, 0x00, 0x00, 0x1c, 0x0c, 0xfc,
    0xfc, 0x0c, 0x1c, 0x00, 0x00, 0x00, 0x08, 0x0f, 0x0f, 0x08, 0x00, 0x00, 0xfc, 0xfc, 0x00, 0x00, 0x00, 0xfc, 0xfc,
    0x00, 0x07, 0x0f, 0x08, 0x08, 0x08, 0x0f, 0x07, 0x00, 0xfc, 0xfc, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0x00, 0x01, 0x03,
    0x06, 0x0c, 0x06, 0x03, 0x01, 0x00, 0xfc, 0xfc, 0x00, 0x80, 0x00, 0xfc, 0xfc, 0x00, 0x0f, 0x07, 0x03, 0x01, 0x03,
    0x07, 0x0f, 0x00, 0x0c, 0x3c, 0xf0, 0xe0, 0xf0, 0x3c, 0x0c, 0x00, 0x0c, 0x0f, 0x03, 0x01, 0x03, 0x0f, 0x0c, 0x00,
    0x00, 0x3c, 0x7c, 0xc0, 0xc0, 0x7c, 0x3c, 0x00, 0x00, 0x00, 0x08, 0x0f, 0x0f, 0x08, 0x00, 0x00, 0x1c, 0x0c, 0x84,
    0xc4, 0x64, 0x3c, 0x1c, 0x00, 0x0e, 0x0f, 0x09, 0x08, 0x08, 0x0c, 0x0e, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0x04, 0x04,
    0x00, 0x00, 0x00, 0x00, 0x0f, 0x0f, 0x08, 0x08, 0x00, 0x00, 0x18, 0x30, 0x60, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x03, 0x06, 0x00, 0x00, 0x00, 0x04, 0x04, 0xfc, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x08, 0x08,
    0x0f, 0x0f, 0x00, 0x00, 0x20, 0x30, 0x18, 0x0c, 0x18, 0x30, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x00, 0x00,
    0x00, 0x0e, 0x16, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xa0, 0xa0, 0xa0, 0xe0,
    0xc0, 0x00, 0x00, 0x07, 0x0f, 0x08, 0x08, 0x07, 0x0f, 0x08, 0x00, 0x04, 0xfc, 0xfc, 0x20, 0x20, 0xe0, 0xc0, 0x00,
    0x00, 0x0f, 0x0f, 0x08, 0x08, 0x0f, 0x07, 0x00, 0xc0, 0xe0, 0x20, 0x20, 0x20, 0x60, 0x40, 0x00, 0x07, 0x0f, 0x08,
    0x08, 0x08, 0x0c, 0x04, 0x00, 0xc0, 0xe0, 0x20, 0x24, 0xfc, 0xfc, 0x00, 0x00, 0x07, 0x0f, 0x08, 0x08, 0x07, 0x0f,
    0x08, 0x00, 0xc0, 0xe0, 0x20, 0x20, 0x20, 0xe0, 0xc0, 0x00, 0x07, 0x0f, 0x09, 0x09, 0x09, 0x0d, 0x05, 0x00, 0x00,
    0x20, 0xf8, 0xfc, 0x24, 0x2c, 0x08, 0x00, 0x00, 0x08, 0x0f, 0x0f, 0x08, 0x00, 0x00, 0x00, 0xc0, 0xe0, 0x20, 0x20,
    0xc0, 0xe0, 0x20, 0x00, 0x27, 0x6f, 0x48, 0x48, 0x7f, 0x3f, 0x00, 0x00, 0x04, 0xfc, 0xfc, 0x40, 0x20, 0xe0, 0xc0,
    0x00, 0x08, 0x0f, 0x0f, 0x00, 0x00, 0x0f, 0x0f, 0x00, 0x00, 0x00, 0x20, 0xec, 0xec, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x08, 0x0f, 0x0f, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0xec, 0xec, 0x00, 0x00, 0x30, 0x70, 0x40, 0x40, 0x7f,
    0x3f, 0x00, 0x00, 0x04, 0xfc, 0xfc, 0x80, 0xc0, 0x60, 0x20, 0x00, 0x08, 0x0f, 0x0f, 0x01, 0x03, 0x0e, 0x0c, 0x00,
    0x00, 0x00, 0x04, 0xfc, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x0f, 0x0f, 0x08, 0x00, 0x00, 0xe0, 0xe0, 0x60,
    0xc0, 0x60, 0xe0, 0xc0, 0x00, 0x0f, 0x0f, 0x00, 0x07, 0x00, 0x0f, 0x0f, 0x00, 0x20, 0xe0, 0xc0, 0x20, 0x20, 0xe0,
    0xc0, 0x00, 0x00, 0x0f, 0x0f, 0x00, 0x00, 0x0f, 0x0f, 0x00, 0xc0, 0xe0, 0x20, 0x20, 0x20, 0xe0, 0xc0, 0x00, 0x07,
    0x0f, 0x08, 0x08, 0x08, 0x0f, 0x07, 0x00, 0x20, 0xe0, 0xc0, 0x20, 0x20, 0xe0, 0xc0, 0x00, 0x40, 0x7f, 0x7f, 0x48,
    0x08, 0x0f, 0x07, 0x00, 0xc0, 0xe0, 0x20, 0x20, 0xe0, 0xe0, 0x00, 0x00, 0x07, 0x0f, 0x08, 0x48, 0x7f, 0x7f, 0x40,
    0x00, 0x20, 0xe0, 0xc0, 0x60, 0x20, 0x60, 0x60, 0x00, 0x08, 0x0f, 0x0f, 0x08, 0x00, 0x00, 0x00, 0x00, 0x40, 0xe0,
    0xa0, 0x20, 0x20, 0x60, 0x40, 0x00, 0x04, 0x0c, 0x09, 0x09, 0x0b, 0x0e, 0x04, 0x00, 0x20, 0x20, 0xf8, 0xfc, 0x20,
    0x20, 0x00, 0x00, 0x00, 0x00, 0x07, 0x0f, 0x08, 0x04, 0x00, 0x00, 0xe0, 0xe0, 0x00, 0x00, 0xe0, 0xe0, 0x00, 0x00,
    0x07, 0x0f, 0x08, 0x08, 0x07, 0x0f, 0x08, 0x00, 0xe0, 0xe0, 0x00, 0x00, 0x00, 0xe0, 0xe0, 0x00, 0x01, 0x03, 0x06,
    0x0c, 0x06, 0x03, 0x01, 0x00, 0xe0, 0xe0, 0x00, 0xc0, 0x00, 0xe0, 0xe0, 0x00, 0x07, 0x0f, 0x0c, 0x07, 0x0c, 0x0f,
    0x07, 0x00, 0x60, 0xe0, 0x80, 0x00, 0x80, 0xe0, 0x60, 0x00, 0x0c, 0x0e, 0x03, 0x01, 0x03, 0x0e, 0x0c, 0x00, 0xe0,
    0xe0, 0x00, 0x00, 0x00, 0xe0, 0xe0, 0x00, 0x47, 0x4f, 0x48, 0x48, 0x68, 0x3f, 0x1f, 0x00, 0x60, 0x20, 0x20, 0xa0,
    0xe0, 0x60, 0x20, 0x00, 0x0c, 0x0e, 0x0b, 0x09, 0x08, 0x08, 0x0c, 0x00, 0x00, 0x40, 0x40, 0xf8, 0xbc, 0x04, 0x04,
    0x00, 0x00, 0x00, 0x00, 0x07, 0x0f, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x3c, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x0f, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0xbc, 0xf8, 0x40, 0x40, 0x00, 0x00, 0x08, 0x08, 0x0f, 0x07,
    0x00, 0x00, 0x00, 0x08, 0x0c, 0x04, 0x0c, 0x08, 0x0c, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

// https://github.com/datacute/TinyOLED-Fonts/blob/master/src/font16x16cn.h
__code uint8_t OLED_FONT_CHINESE_16x16[] = {
    0x00, 0x02, 0x02, 0xFA, 0xFA, 0xAA, 0xAA, 0xFF, 0xFF, 0xAA, 0xAA, 0xFA, 0xFA, 0x02, 0x02, 0x00,
    0x00, 0x42, 0x72, 0x72, 0x3A, 0x7A, 0x42, 0x4B, 0x5B, 0x52, 0x62, 0x62, 0x13, 0x77, 0x66, 0x00,  // "惠",0

    0x20, 0x3C, 0x1C, 0xFF, 0xFF, 0xB0, 0xB4, 0x24, 0x24, 0x3F, 0x3F, 0xE4, 0xE4, 0x24, 0x24, 0x20,
    0x02, 0x02, 0x03, 0xFF, 0xFF, 0x00, 0x01, 0x05, 0x1D, 0x59, 0xC1, 0xFF, 0x7F, 0x01, 0x01, 0x01,  // "特",1

    0x00, 0x00, 0x00, 0xF8, 0xF8, 0x48, 0x4C, 0x4F, 0x4B, 0x4A, 0x48, 0x48, 0xF8, 0xF8, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xFF, 0xFF, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0xFF, 0xFF, 0x00, 0x00,  // "自",2

    0x20, 0x24, 0x24, 0xE4, 0xE4, 0x24, 0x24, 0x24, 0x30, 0x10, 0xFF, 0xFF, 0x10, 0xF0, 0xF0, 0x00,
    0x08, 0x1C, 0x1F, 0x0B, 0x0C, 0x0D, 0x4F, 0x6E, 0x34, 0x1C, 0x0F, 0x23, 0x60, 0x7F, 0x3F, 0x00,  // "动",3

    0x80, 0xC0, 0x60, 0xF8, 0xFF, 0x07, 0x02, 0x00, 0xFF, 0xFF, 0xE0, 0x70, 0x3C, 0x1C, 0x08, 0x00,
    0x00, 0x00, 0x00, 0x7F, 0x7F, 0x04, 0x06, 0x03, 0x3F, 0x7F, 0x40, 0x40, 0x40, 0x78, 0x78, 0x00,  // "化",4
};

// OLED initialization sequence
__code uint8_t OLED_INIT_CMD[] = {
    OLED_MULTIPLEX,   0x3F,  // set multiplex ratio
    OLED_CHARGE_PUMP, 0x14,  // set DC-DC enable
    OLED_MEMORY_MODE, 0x02,  // set page addressing mode
    OLED_COM_PINS,    0x12,  // set com pins
    OLED_CONTRAST,    0x3f,  // set contrast 63 / 255
    OLED_DISPLAY_ON          // display on
};

__data uint8_t _page;    // OLED memory pages, from 0 to 7.
__data uint8_t _column;  // OLED memory columns, from 0 to 127.
__data uint8_t _font;

// OLED init function
void OLED_init(void)
{
    I2C_init();                // initialize I2C first
    I2C_start(OLED_ADDR);      // start transmission to OLED
    I2C_write(OLED_CMD_MODE);  // set command mode
    for (uint8_t i = 0; i < sizeof(OLED_INIT_CMD); i++)
    {
        I2C_write(OLED_INIT_CMD[i]);  // send the command bytes
    }
    I2C_stop();    // stop transmission
    OLED_clear();  // clear screen
}

// Set memory address in page addressing mode
void OLED_setAddress(uint8_t page, uint8_t column)
{
    _page   = page % 8;
    _column = column;
    I2C_start(OLED_ADDR);                       // start transmission to OLED
    I2C_write(OLED_CMD_MODE);                   // set command mode
    I2C_write(OLED_PAGE | _page);               // set page
    I2C_write(_column & 0x0F);                  // set lower column start address [0x00, 0x0F], x & 0x0F
    I2C_write(0x10 + ((_column >> 4) & 0x0F));  // set upper column start address [0x10, 0x1F], (x >> 4) & 0x0F
    I2C_stop();                                 // stop transmission
}

// Clear page in page addressing mode
void OLED_clearPage(uint8_t page)
{
    OLED_setAddress(page, 0);   // set cursor to line start
    I2C_start(OLED_ADDR);       // start transmission to OLED
    I2C_write(OLED_DATA_MODE);  // set data mode
    for (uint8_t col = 128; col; col--)
        I2C_write(0x00);  // clear the line
    I2C_stop();           // stop transmission
}

// Clear screen in page addressing mode
void OLED_clear(void)
{
    for (uint8_t page = 0; page < 8; page++)
        OLED_clearPage(page);
    OLED_setAddress(0, 0);
}

// Helper
void OLED_plotChar16(const uint8_t* data, uint8_t width)
{
    uint8_t w;

    I2C_start(OLED_ADDR);       // start transmission to OLED
    I2C_write(OLED_DATA_MODE);  // set data mode
    for (w = width; w; w--)
    {
        I2C_write(*data++);
    }
    I2C_stop();  // stop transmission

    OLED_setAddress(_page + 1, _column);

    I2C_start(OLED_ADDR);       // start transmission to OLED
    I2C_write(OLED_DATA_MODE);  // set data mode
    for (w = width; w; w--)
    {
        I2C_write(*data++);
    }
    I2C_stop();  // stop transmission

    _column += width;
    OLED_setAddress(_page - 1, _column);
}

// Plot a single character
void OLED_plotChar(char c)
{
    uint16_t ptr;  // character pointer

    if (_font == FONT_5x8)
    {
        if (c < 32)
        {
            return;
        }
        ptr = c - 32;
        ptr += ptr << 2;            // -> ptr = (ch - 32) * 5;
        I2C_start(OLED_ADDR);       // start transmission to OLED
        I2C_write(OLED_DATA_MODE);  // set data mode
        for (uint8_t i = 5; i; i--)
        {
            I2C_write(OLED_FONT_5x8[ptr++]);
        }
        I2C_write(0x00);  // write space between characters
        I2C_stop();       // stop transmission

        _column += 6;
    }
    else if (_font == FONT_DOS_8x16)
    {
        if (c < 32)
        {
            return;
        }
        ptr = c - 32;
        ptr <<= 4;  // -> ptr = (ch - 32) * 16;
        OLED_plotChar16(&OLED_FONT_DOS_8x16[ptr], 8);
    }
    else if (_font == FONT_CHINESE_16x16)
    {
        ptr = c << 5;  // -> ptr = ch * 32;
        OLED_plotChar16(&OLED_FONT_CHINESE_16x16[ptr], 16);
    }
}

// OLED write a character or handle control characters
void OLED_write(char c)
{
    c = c & 0x7F;  // Ignore MSB

    if (c == '\n')  // new line
    {
        OLED_setAddress(_page++, 0);
    }
    else
    {
        OLED_plotChar(c);
        if (_column > 127)
        {
            OLED_setAddress(_page++, 0);
        }
    }
}

void OLED_setFont(uint8_t font)
{
    _font = font;
}

void OLED_setCursor(uint8_t row, uint8_t col)
{
    if (_font == FONT_DOS_8x16)
    {
        _page   = row << 1;
        _column = col << 3;
    }
    else if (_font == FONT_CHINESE_16x16)
    {
        _page   = row << 1;
        _column = col << 4;
    }
    else
    {
        _page   = row;
        _column = (col << 1) + (col << 2);
    }
    OLED_setAddress(_page, _column);
}

void OLED_print(const char* str)
{
    while (*str)
        OLED_write(*str++);
}
